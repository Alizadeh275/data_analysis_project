<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Orders Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .filters { margin-bottom: 20px; }
    .filters label { margin-right: 10px; }
    #chartContainer { width: 80%; max-width: 900px; margin: auto; }
  </style>
</head>
<body>

<h1>Work Orders Dashboard</h1>

<div class="filters">
  <label>Location:
    <select id="filterLocation">
      <option value="">All</option>
      <option value="1">City 1</option>
      <option value="2">City 2</option>
      <!-- add more as needed -->
    </select>
  </label>

  <label>Project Type:
    <select id="filterProjectType">
      <option value="">All</option>
      <option value="1">Type 1</option>
      <option value="2">Type 2</option>
    </select>
  </label>

  <label>Status:
    <select id="filterStatus">
      <option value="">All</option>
      <option value="1">Open</option>
      <option value="2">Closed</option>
    </select>
  </label>

  <label>Year:
    <select id="filterYear">
      <option value="">All</option>
      <option value="2023">2023</option>
      <option value="2024">2024</option>
    </select>
  </label>

  <label>Month:
    <select id="filterMonth">
      <option value="">All</option>
      <option value="1">Jan</option>
      <option value="2">Feb</option>
      <option value="3">Mar</option>
      <option value="4">Apr</option>
      <option value="5">May</option>
      <option value="6">Jun</option>
      <option value="7">Jul</option>
      <option value="8">Aug</option>
      <option value="9">Sep</option>
      <option value="10">Oct</option>
      <option value="11">Nov</option>
      <option value="12">Dec</option>
    </select>
  </label>

  <label>Group By:
    <select id="groupBy" multiple size="5">
      <option value="location">Location</option>
      <option value="project_type">Project Type</option>
      <option value="status">Status</option>
      <option value="year">Year</option>
      <option value="month">Month</option>
    </select>
  </label>

  <button id="applyFilters">Apply</button>
</div>

<div id="chartContainer">
  <canvas id="myChart"></canvas>
</div>

<script>
let myChart = null;

function fetchAndRenderChart() {
  const location_id = $('#filterLocation').val();
  const project_type_id = $('#filterProjectType').val();
  const status_id = $('#filterStatus').val();
  const year = $('#filterYear').val();
  const month = $('#filterMonth').val();
  const group_by = $('#groupBy').val() || [];

  // Build API URL with query parameters
  let url = '/aggregations/sum?';
  if(location_id) url += `location_id=${location_id}&`;
  if(project_type_id) url += `project_type_id=${project_type_id}&`;
  if(status_id) url += `status_id=${status_id}&`;
  if(year) url += `year=${year}&`;
  if(month) url += `month=${month}&`;
  group_by.forEach(g => url += `group_by=${g}&`);

  // Remove trailing &
  url = url.slice(0, -1);

  $.get(url, function(data) {
    const chartData = data.chart_data;

    if(chartData.length === 0) {
      alert("No data for selected filters.");
      return;
    }

    // Determine chart labels and datasets dynamically
    let labels = [];
    let datasets = [];

    if(group_by.length === 1) {
      labels = chartData.map(item => item[group_by[0]]);
      datasets = [{
        label: 'Work Orders',
        data: chartData.map(item => item.count),
        backgroundColor: 'rgba(54, 162, 235, 0.7)'
      }];
    } else if(group_by.length === 2) {
      // Grouped bar chart for 2 dimensions
      const dim1 = group_by[0];
      const dim2 = group_by[1];

      const dim1Labels = [...new Set(chartData.map(item => item[dim1]))];
      const dim2Labels = [...new Set(chartData.map(item => item[dim2]))];

      labels = dim1Labels;
      datasets = dim2Labels.map((d2, idx) => {
        return {
          label: d2,
          data: dim1Labels.map(d1 => {
            const row = chartData.find(item => item[dim1]===d1 && item[dim2]===d2);
            return row ? row.count : 0;
          }),
          backgroundColor: `rgba(${(idx*50)%255}, ${100+idx*30}, ${200-idx*20}, 0.7)`
        };
      });
    } else {
      alert("Charts for more than 2 group_by dimensions are not supported yet.");
      return;
    }

    // Destroy previous chart if exists
    if(myChart) myChart.destroy();

    const ctx = document.getElementById('myChart').getContext('2d');
    myChart = new Chart(ctx, {
      type: group_by.length === 1 ? 'bar' : 'bar',
      data: {
        labels: labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  });
}

$('#applyFilters').on('click', fetchAndRenderChart);

// Initial load
fetchAndRenderChart();
</script>

</body>
</html>
